<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
    <script src="https://www.mapquestapi.com/sdk/leaflet/v2.s/mq-map.js?key=e8KE3frcmrcs4PB7qEZq51Ztnh2ftGC3"></script>
</head>
<body>
    <div id="map" style="width:92%; height:99%; position:absolute"></div>

	<script>
        var lat = 47.62201666666667;
        var lon = -122.335685;

        var mapLayer = MQ.mapLayer(), map;
        var darkLayer = MQ.darkLayer();
        var satelliteLayer = MQ.satelliteLayer();

        map = L.map('map', {
            layers: mapLayer,
            center: [lat, lon],
            zoom: 10
            });

        map.on('click', function(e)
        {
            if (e.originalEvent.altKey)
            {
                MapThis.mapClicked(e.latlng.lat, e.latlng.lng);
            }
        });

        var popup = L.popup();


        function setMapLayer()
        {
            map.removeLayer(darkLayer);
            map.removeLayer(satelliteLayer);
            map.addLayer(mapLayer);
        }

        function setSatelliteLayer()
        {
            map.removeLayer(mapLayer);
            map.removeLayer(darkLayer);
            map.addLayer(satelliteLayer);
        }

        function setDarkLayer()
        {
            map.removeLayer(mapLayer);
            map.removeLayer(satelliteLayer);
            map.addLayer(darkLayer);
        }

		function setCenter(location, zoom)
		{
			map.setView(location, zoom);
		}

		function fitToBounds(bounds)
		{
			map.fitBounds(bounds);
		}

        var activeMarkers = [];
		function addMarker(name, id, location, title)
		{
			marker = L.marker(location, { draggable:'true', title:title } );
            setMarkerId(marker, id);
            activeMarkers.push(marker);

            marker.on('dragend', function(event) {
                var marker = event.target;
                var position = marker.getLatLng();
                var id = markerId(marker);
                MapThis.updateMarker(id, position.lat, position.lng);
            });

            marker.on('click', function(event) {
                MapThis.markerClicked(name);
            });

            marker.addTo(map);
		}

        function removeAllMarkers()
        {
            for (idx = 0; idx < activeMarkers.length; ++idx) {
                map.removeLayer(activeMarkers[idx]);
            }
            activeMarkers.length = 0;
        }

        var allSensitiveLocations = [];
        function addSensitiveLocation(location, radius)
        {
            circle = L.circle(location, radius, {
                                  stroke: false,
                                  fillColor: '#f03',
                                  fillOpacity: 0.5
                              });
            circle.addTo(map);
            allSensitiveLocations.push(circle)
        }

        function removeAllSensitiveLocations()
        {
            for (idx = 0; idx < allSensitiveLocations.length; ++idx) {
                map.removeLayer(allSensitiveLocations[idx]);
            }
            allSensitiveLocations.length = 0;
        }

		function setPopup(location, s)
		{
			popup
				.setLatLng(location)
				.setContent(s)
				.openOn(map);
		}

		function resetPopup()
		{
			map.closePopup(popup);
		}

        function toggleSensitiveLocation(lat, lon)
        {
            MapThis.toggleSensitiveLocation(lat, lon)
        }

		function pointToLatLng(p)
		{
			var ll = map.containerPointToLatLng(p);
			return JSON.stringify(ll);
		}

        function markerId(obj)
        {
            return String(obj.__obj_id);
        }

        function setMarkerId(obj, id)
        {
            obj.__obj_id = id;
        }
	</script>
</body>
</html>
